---
title: "Final Project IS607: Disaggregate Real Estate Analysis"
author: "Talha Muhammad, Marco Siqueira Campos, KaMan Chan, Sharon Morris"
date: "December 18, 2016"
output: html_document
---

```{r packages, warning=FALSE,message=FALSE}
library(RCurl)
library(XML)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(geosphere)
```

```{r ids and pwds}
#zillowid=option("insert your zillowapi credentials")
```
# Goals and Aims
In addition to the aggregate analysis (focusing on median prices at the zip code level), we wanted to understand the impact of crime and other attibutes on property values(number of bedrooms, bathrooms, distance from the Central Business District and "neigbhorhood premium") at a disaggregate level. Due to Zillow API call limits and time the analysis focused on Northwest and Central Brooklyn, in New York City - however the approach is very general and can easily be extended to other areas of Brooklyn and even New York City. 


# Phase I: Getting the data
The data is collected from different sources.   
1. Planning data from Pluto for Addresses (input to Zillow) 
2. Real Estate data from Zillow (using Zillow's deepsearch API)    
3. Crime data from NYPD 


### i) Planning database
Pluto data from NYC planning department is used to provide addresses to get the latest data from Zillow (source:http://www1.nyc.gov/site/planning/data-maps/open-data/dwn-pluto-mappluto.page). Addresses obtained are then used to make call from the Zillow API.    
The code below identifies how these addresses were selected - primarily using building codes. Since the zillow API places a constraint of 1000 calls per day and due to limited time, the analysis 


```{r Identify Addresses}
#source pluto database from NYC
plutodata<-read.csv(text=getURL("https://raw.githubusercontent.com/cunyauthor/FinalProject/master/BK.csv"),header=TRUE,stringsAsFactors=FALSE) 

#focus analysis on certain zip codes
#central brooklyn, northwest brooklyn and greenpoint
#filter by zip code
nw<-c("11201", "11205", "11215", "11217", "11231")
gp<-c("11211", "11222")
cb<-c("11212", "11213", "11216", "11233", "11238")

#select residential buildings 
#filter data by building types and codes
#two family
fmly<-c("B1","B2","B3")
#walkup Apartments
walkup<-c("C0","C1","C2","C3","C4","C5","C6","C7")
# Elevator Apartments
elev<-c("D0","D1","D3","D4","D5","D6","D7","D8")
#Condominiums
condo<-c("R1","R2","R3","R4","R6","RD","RM","RR")
#combined buildings
# limiting type of buildings due to constraints imposed by zillow of 1000 API calls per day
buildings<-c(elev,condo)

#select neighborhood areas and building types
selectdata<-plutodata %>% filter(ZipCode==nw[1] | ZipCode==nw[2] | ZipCode==nw[3] | ZipCode==nw[4]| ZipCode==nw[5] | ZipCode==cb[1] | ZipCode==cb[2]| ZipCode==cb[3]| ZipCode==cb[4] | ZipCode==cb[5])

#select buidings
finaldata<-selectdata[(selectdata$BldgClass %in% buildings),]
#select columns
finaldata<-select(finaldata,one_of(c("CD","CT2010","CB2010","SchoolDist","ZipCode","Address","BldgClass","UnitsRes","YearBuilt","NumFloors")))

# dimensions of data
dim(finaldata)
# head of the data
head(finaldata)
#convert factors to character types
finaldata$Address<-as.character(finaldata$Address)
finaldata$BldgClass<-as.character(finaldata$BldgClass)
#structure of dataset
str(finaldata)
# Count of Zipcodes covered
finaldata %>% count(ZipCode)
# Count of Building Class
finaldata %>% count(BldgClass)
```

### ii) Zillow Data
Addresses from the New York City Pluto database are used to make API calls to Zillow. Addresses are a required input to the Zillow API. As part of the analysis we define three functions to collect data from Zillow.The code was modified and adapted (signficantly) from the following stackoverflow source (http://stackoverflow.com/questions/17349630/r-dataframe-from-xml-when-values-are-multiple-or-missing).       
The **zillowcaller** function takes in as inputs addresses in zillow api call form, zip codes and the number of calls to make and the starting number of the call. The  **zillowfunction** function takes as input the parsed XML from the API and then selects various attributes from the XML nodes. Finally the **zillowaggregator** combined all the attributes into a single dataframe.              
We use the **GetDeepSearch** API from zillow for this analysis.      
    
```{r Prepare for Zillow}
#select all the addresses
address<-finaldata$Address
#make it to zillow form
address<-str_replace_all(address," ","+")
#city state to zillow form
citystate<-str_c("Brooklyn%2C+NY+",finaldata$ZipCode)

#URL for the deep search API at Zillow
zillow_url<-"http://www.zillow.com/webservice/GetDeepSearchResults.htm?"

#define a function to make api calls
zillowcaller<-function(add,zip,nos,start,zillowadd){
for (i in 1:nos) {
  feed<-getURL(paste0(zillowadd,"zws-id=",getOption("zillowid"),"&address=",add[i+start],"&citystatezip=",zip[i+start]))
  Sys.sleep(1)
  if(i==1){
    last<-xmlParse(feed)
  }
  else {
    temp<-xmlParse(feed)
    last<-c(last,temp)
  }
}
  return(last)
}


# define zillow function to parse and extract relevant attributes from zillow api calls
zillowfunction<-function(xmldata){
do.call(rbind, xpathApply(xmldata, "//result", function(node) {

   zpid<-xmlValue(node[["zpid"]])
   bathrooms <- xmlValue(node[["bathrooms"]])
   bedrooms <- xmlValue(node[["bedrooms"]])
   sqft<-xmlValue(node[["finishedSqFt"]])
   st <- xpathSApply(node,"./address/street", xmlValue)
   zip <- xpathSApply(node,"./address/zipcode", xmlValue)
   city<-xpathSApply(node,"./address/city", xmlValue)
   state<-xpathSApply(node,"./address/state", xmlValue)
   lat<-xpathSApply(node,"./address/latitude", xmlValue)
   long<-xpathSApply(node,"./address/longitude", xmlValue)
   valuation<-xpathSApply(node,"./zestimate/amount", xmlValue)
   lowval<-xpathSApply(node,"./zestimate/valuationRange/low", xmlValue)
   highval<-xpathSApply(node,"./zestimate/valuationRange/high", xmlValue)
   nb<-xpathSApply(node,"//result/localRealEstate/region",xmlAttrs)[[1]]
   nbid<-xpathSApply(node,"//result/localRealEstate/region",xmlAttrs)[[2]]
   return(data.frame(zpid,bathrooms, bedrooms,sqft,st,city,state,lat,long,valuation,lowval,highval,nb,nbid, stringsAsFactors = FALSE))
}))
}

#zillow aggregator function
zillowaggregator <- function(call){
for (i in 2:length(call)) {
  if(i==2) {
    output<-rbind(zillowfunction(call[[1]]),zillowfunction(call[[2]]))
  }
else {
  output<-rbind(output,zillowfunction(call[[i]]))
     }
}
  return(output)
}

```

We make the zillow api calls below to collect the data. However, due to call limits we have already collected the data and stored on github for this analysis.      

```{r make Zillow calls}
#return a list of calls to api
#daily limit of 1000 calls  

#calls were made over 2 days to meet the limits

#firstcall<-zillowcaller(address,citystate,40,0,zillow_url)
#zillowdata<-zillowaggregator(firstcall)
#secondcall<-zillowcaller(address,citystate,980,40,zillow_url)
#two<-zillowaggregator(secondcall)
#thirdcall<-zillowcaller(address,citystate,972,1020,zillow_url)
#three<-zillowaggregator(thirdcall)
#zillowdata<-rbind(zillowdata,three,two)

#read in the precollected data from github
zillowdata<-read.csv(text=getURL("https://raw.githubusercontent.com/cunyauthor/FinalProject/master/zillowdata.csv"),stringsAsFactors = FALSE)
zillowdata<-rename(zillowdata,number=X)
```
# Phase II: Cleaning the data

```{r Clean Zillow Data}
zillowdata$zpid<-as.numeric(zillowdata$zpid)
zillowdata$nbid<-as.numeric(zillowdata$nbid)
zillowdata$valuation<-as.numeric(zillowdata$valuation)
zillowdata$lowval<-as.numeric(zillowdata$lowval)
zillowdata$highval<-as.numeric(zillowdata$highval)
zillowdata$bedrooms<-as.integer(zillowdata$bedrooms)
zillowdata$bathrooms<-as.numeric(zillowdata$bathrooms)
zillowdata$sqft<-as.numeric(zillowdata$sqft)
str(zillowdata)
head(zillowdata)

#select data to ensure unique observations
zillowdata<-zillowdata[(zillowdata$zpid %in% unique(zillowdata$zpid)),]
##select data where valuation and bedrooms are non-missing
zillow_clean<-zillowdata[!is.na(zillowdata$bedrooms)&!is.na(zillowdata$valuation),]
#remove homes greater than 5 bedrooms
zillow_clean<-filter(zillow_clean,bedrooms<=5)
# remove homes greater $10 million
zillow_clean<-filter(zillow_clean,valuation<=10000000)
# remove neighborhoods with less than 10 observations
neighborhoods<-c("Canarsie","Williamsburg","Ocean Hill","Brownsville","Chelsea","Vinegar Hill","Garment District","Greenwood","Red Hook","Wingate")

zillow_clean<-zillow_clean[!(zillow_clean$nb %in% neighborhoods),]
```


### Calculating Distance
Property prices have a distance and accessibility premium. Residential properties 
```{r Distance}
# Identify a point in Manhattan
#location refers to mid-town Manhattan
ref_lat=40.75047
ref_long=-73.98961
ref_loc<-c(ref_long,ref_lat)
zillow_clean$ref_long<-ref_long
zillow_clean$ref_lat<-ref_lat

# calculate "crow-fly" distance between mid-town and property location 
zillow_clean$distance <- distGeo(zillow_clean[,c('long','lat')], zillow_clean[,c('ref_long','ref_lat')],a=6378137,f=1/298.257223563
)
#convert distance to miles from meters
zillow_clean$distance<-zillow_clean$distance*0.000621371
```

### Summary statistics
      
Summary statistics from the data. 
```{r summary statistics}
zillow_clean %>% count(nb) %>% arrange(desc(n))
zillow_clean %>% count(bedrooms)
zillow_clean %>% count(bathrooms)%>% arrange(desc(n))
summarize(group_by(zillow_clean,nb),med=median(valuation),avg=mean(valuation))%>% arrange(desc(med))
summarize(group_by(zillow_clean,bedrooms),med=median(valuation),avg=mean(valuation))%>% arrange(desc(med))
```



### Conducting some plots and visualizations
The visualizations below show the valuation of the properties. Valuations show a very long tail and is similar to a log normal distribution
```{r Data Visualizations1}
#plot of the valuation data
plot<-ggplot(data=zillow_clean,aes(x=valuation))
plot+geom_histogram(fill="blue",binwidth = 100000)+ggtitle("Zillow House Prices")
plot_lo<-ggplot(data=zillow_clean,aes(x=lowval))
plot_lo+geom_histogram(fill="orange",binwidth = 100000)+ggtitle("Zillow House Prices- Low Estimate")+xlab("Low Valuation")
plot_hi<-ggplot(data=zillow_clean,aes(x=highval))
plot_hi+geom_histogram(fill="darkgreen",binwidth = 100000)+ggtitle("Zillow House Prices- High Estimate")+xlab("High Valuation")
```

```{r Data Visualizations2}
#convert to factor
zillow_clean$bedrooms<-as.factor(zillow_clean$bedrooms)
zillow_clean$bathrooms<-as.factor(zillow_clean$bathrooms)
#plot of square feet and valuation
plot<-ggplot(data=zillow_clean[zillow_clean$sqft<10000&!is.na(zillow_clean$sqft),],aes(x=sqft, y=valuation))
plot+geom_point(aes(color=bedrooms))+ggtitle("Valuations vs Sq.Ft")+ylab("Property Value in $")+scale_y_continuous(breaks=seq(0,10000000,2000000))
#plot of distance and valuation
plot<-ggplot(data=zillow_clean,aes(x=distance, y=valuation))
plot+geom_point(aes(color=bedrooms))+ggtitle("Valuations vs Distance")+ylab("Property Value in $")+xlab("Distance in miles")+scale_y_continuous(breaks=seq(0,10000000,2000000))
#Box plot of property prices 
ggplot(zillow_clean, aes(y=valuation, x=bedrooms)) + geom_boxplot(aes(color=bedrooms))+ylab("Property Value in $")+xlab("Bedrooms")+ggtitle("Box Plots of Property Value")
#Box plot of property sizes 
ggplot(zillow_clean[zillow_clean$sqft<10000&!is.na(zillow_clean$sqft),], aes(y=sqft, x=bedrooms)) + geom_boxplot(aes(color=bedrooms))+ylab("Size in Square Feet")+xlab("Bedrooms")+ggtitle("Box Plots of Property Size")
```
